<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2Fly Client Portal ‚Äî Status & Approvals</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f1f5f9; --panel:#ffffff; --muted:#64748b; --text:#0f172a;
    --brand:#7c5cff; --brand-2:#58e1ff; --ok:#22c55e; --warn:#facc15; --bad:#ef4444; --stroke:#e2e8f0;
    --header-bg:#2563eb; --header-text:#ffffff;
    --blue-50:#eff6ff; --blue-100:#dbeafe; --blue-500:#3b82f6; --blue-600:#2563eb; --blue-700:#1d4ed8;
    --orange-50:#fff7ed; --orange-100:#ffedd5; --orange-500:#f97316; --orange-600:#ea580c;
    --pink-50:#fdf2f8; --pink-100:#fce7f3; --pink-500:#ec4899;
  }
  *{box-sizing:border-box} html,body{margin:0;height:100%}
  body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background: var(--bg);
    color:var(--text); line-height:1.55;
  }
  body[data-theme="dark"]{
    --bg:#0b0c10; --panel:#121319; --muted:#6b7380; --text:#e8ecf1;
    --brand:#7c5cff; --brand-2:#58e1ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --stroke:#1b1f2a;
    --header-bg:#1e40af; --header-text:#e8ecf1;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:0 16px 80px}
  header{
    display:flex;gap:16px;align-items:center;justify-content:space-between;
    margin:16px 16px 0;padding:20px 24px;
    background:var(--header-bg);color:var(--header-text);
    border-radius:16px;box-shadow:0 4px 12px rgba(37,99,235,.2);
  }
  header .title h1{color:var(--header-text);font-size:24px;font-weight:700;margin:0}
  header .title .sub{color:rgba(255,255,255,.8);font-size:13px;margin-top:4px}
  header .btn{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:var(--header-text);}
  header .btn:hover{background:rgba(255,255,255,.15);}
  header .btn.primary{background:linear-gradient(180deg,#7c5cff,#6246ff);border-color:rgba(255,255,255,.2);color:#ffffff;}
  body[data-theme="dark"] header{box-shadow:0 4px 12px rgba(0,0,0,.3);}
  body[data-theme="dark"] header .btn{background:linear-gradient(180deg,#191b22,#14161c);border-color:rgba(255,255,255,.1);}
  .wrap > *:not(header){padding:24px}
  .brand{display:flex;gap:14px;align-items:center}
  .profile-avatar{
    width:48px;height:48px;border-radius:50%;
    background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.3);
    display:flex;align-items:center;justify-content:center;
    font-size:20px;flex-shrink:0;
  }
  .notification-icon{
    width:40px;height:40px;border-radius:50%;
    background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;transition:background 0.2s;
  }
  .notification-icon:hover{background:rgba(255,255,255,.15);}
  .notification-icon svg{width:20px;height:20px;stroke:white;fill:none;stroke-width:2;}
  .logout-link{
    color:rgba(255,255,255,.9);
    font-size:13px;
    text-decoration:none;
    cursor:pointer;
    padding:8px 12px;
    border-radius:8px;
    transition:all 0.2s;
    white-space:nowrap;
  }
  .logout-link:hover{
    background:rgba(255,255,255,.1);
    color:#ffffff;
  }
  .logo{width:38px;height:38px;border-radius:10px;background:
        conic-gradient(from 210deg at 50% 50%, var(--brand), var(--brand-2) 60%, var(--brand));
        box-shadow:0 6px 24px rgba(124,92,255,.35), inset 0 0 0 2px rgba(255,255,255,.08);
        animation:wiggle 8s ease-in-out infinite}
  @keyframes wiggle{0%,92%,100%{transform:none}94%{transform:rotate(-2deg) translateY(-1px)}96%{transform:rotate(2deg) translateY(1px)}98%{transform:none}}
  .title h1{margin:0;font-size:18px}
  .title .sub{color:var(--muted);font-size:13px;margin-top:2px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--stroke);background:var(--panel);
       color:var(--text);padding:10px 12px;border-radius:10px;font-weight:600;font-size:13px;cursor:pointer}
  body[data-theme="dark"] .btn{background:linear-gradient(180deg,#191b22,#14161c)}
  .btn.primary{background:linear-gradient(180deg,#7c5cff,#6246ff);border-color:rgba(255,255,255,.08);color:#ffffff}
  body[data-theme="dark"] .btn.primary{background:linear-gradient(180deg,#7c5cff,#6246ff);border-color:rgba(255,255,255,.08)}
  .btn.approve{background:#22C55E;border-color:#22C55E;color:#ffffff;font-weight:600}
  .btn.approve:hover{background:#16A34A;border-color:#16A34A}
  .btn.changes{background:#F87171;border-color:#F87171;color:#ffffff;font-weight:600}
  .btn.changes:hover{background:#DC2626;border-color:#DC2626}
  .btn.info{background:#3B82F6;border-color:#3B82F6;color:#ffffff}
  .btn.info:hover{background:#2563EB;border-color:#2563EB}
  .btn.small{padding:6px 10px;font-size:12px;border-radius:8px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .panel{background:var(--panel);
         border:1px solid var(--stroke);border-radius:14px;padding:16px;
         box-shadow:0 2px 8px rgba(0,0,0,.08)}
  body[data-theme="dark"] .panel{box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04)}
  
  /* Section-specific backgrounds */
  .section-overview{background:#ffffff !important;border-radius:16px;padding:24px !important;}
  body[data-theme="dark"] .section-overview{background:#1e293b !important;}
  .panel h3{font-size:18px;font-weight:700;color:#1e40af;margin:0 0 20px 0;}
  body[data-theme="dark"] .panel h3{color:#60a5fa;}
  
  .section-approvals{
    background:#1e40af !important;
    border-radius:16px;
    padding:24px !important;
  }
  body[data-theme="dark"] .section-approvals{
    background:#1e3a8a !important;
  }
  
  .section-requests{
    background:#1e40af !important;
    border-radius:16px;
    padding:24px !important;
  }
  body[data-theme="dark"] .section-requests{background:#1e3a8a !important;}
  
  .section-reports{background:#E8F7FE !important;}
  body[data-theme="dark"] .section-reports{background:#0E171C !important;}
  
  /* Approval Tabs */
  .approval-tabs{
    display:flex;gap:8px;padding:8px;
    background:rgba(255,255,255,.1);border-radius:12px;margin-bottom:20px;
  }
  body[data-theme="dark"] .approval-tabs{background:rgba(255,255,255,.05);}
  .approval-tab{
    flex:1;padding:10px 16px;border-radius:999px;
    background:transparent;border:none;
    color:rgba(255,255,255,.7);font-size:14px;font-weight:500;
    cursor:pointer;transition:all 0.2s;
  }
  .approval-tab:hover{
    color:rgba(255,255,255,.9);
  }
  .approval-tab.active{
    background:#ffffff;color:#1e40af;box-shadow:0 2px 4px rgba(0,0,0,.1);
    font-weight:600;
  }
  body[data-theme="dark"] .approval-tab.active{
    background:#3b82f6;color:#ffffff;
  }
  
  .lane-pending{background:transparent;padding:0;border-radius:0;margin-top:0;}
  .lane-changes{background:transparent;padding:0;border-radius:0;margin-top:0;}
  .lane-approved{background:transparent;padding:0;border-radius:0;margin-top:0;}
  
  .form-quick-request{background:#ffffff;padding:20px;border-radius:12px;margin-top:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
  body[data-theme="dark"] .form-quick-request{background:#334155;}
  
  /* Request Stats */
  .request-stats{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px;}
  .stat-circle{
    display:flex;flex-direction:column;align-items:center;gap:8px;
    background:#ffffff;border-radius:16px;padding:24px;
    box-shadow:0 1px 3px rgba(0,0,0,.1);
  }
  .stat-title{font-size:14px;font-weight:600;color:#1e40af;margin-bottom:4px;}
  .stat-label{font-size:13px;color:#64748b;margin-top:4px;}
  .circular-progress{position:relative;width:120px;height:120px;}
  .progress-value{font-size:24px;font-weight:700;color:#1e40af;line-height:1.2;}
  .progress-unit{font-size:12px;color:#64748b;margin-top:2px;}
  .progress-ring{transform:rotate(-90deg);}
  .progress-ring-background{stroke:var(--stroke);}
  body[data-theme="dark"] .progress-ring-background{stroke:#374151;}
  .progress-ring-fill{stroke-dasharray:314.16;stroke-dashoffset:314.16;transition:stroke-dashoffset 0.6s ease;}
  .progress-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;}
  .progress-value{font-size:24px;font-weight:700;color:var(--text);line-height:1.2;}
  .progress-unit{font-size:12px;color:var(--muted);margin-top:2px;}
  .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:8px}
  body[data-theme="dark"] .card{background:#0f1117}
  .metric{font-size:26px;font-weight:700}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;background:var(--surface);border:1px solid var(--stroke);color:var(--muted)}
  body[data-theme="dark"] .chip{background:#121420}
  .chip.ok{background:rgba(34,197,94,.12);color:#16a34a;border-color:rgba(34,197,94,.35);font-weight:500}
  body[data-theme="dark"] .chip.ok{color:#a7f3d0}
  .chip.warn{background:rgba(250,204,21,.12);color:#ca8a04;border-color:rgba(250,204,21,.35);font-weight:500}
  body[data-theme="dark"] .chip.warn{color:#fde68a}
  .chip.bad{background:rgba(239,68,68,.12);color:#dc2626;border-color:rgba(239,68,68,.35);font-weight:500}
  body[data-theme="dark"] .chip.bad{color:#fecaca}
  .list{display:flex;flex-direction:column;gap:12px}
  .row{
    display:flex;gap:16px;align-items:center;justify-content:space-between;
    border:none;padding:16px;border-radius:12px;
    background:#ffffff;box-shadow:0 1px 3px rgba(0,0,0,.1);
    transition:all 0.2s ease;cursor:pointer;
    margin-bottom:0;
  }
  body[data-theme="dark"] .row{
    background:#334155;box-shadow:0 2px 4px rgba(0,0,0,.2);
  }
  .row:hover{
    box-shadow:0 4px 8px rgba(0,0,0,.12);
    transform:translateY(-1px);
  }
  body[data-theme="dark"] .row:hover{box-shadow:0 4px 12px rgba(0,0,0,.3);}
  .row .left{display:flex;gap:12px;align-items:flex-start;flex:1;min-width:0}
  .status-dot{width:10px;height:10px;border-radius:999px;margin-top:6px;background:var(--warn)}
  .type-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;background:#f1f5f9;border:none;flex-shrink:0;margin-top:2px}
  body[data-theme="dark"] .type-icon{background:#475569;}
  .row .meta{color:#64748b;font-size:13px;margin-top:6px}
  body[data-theme="dark"] .row .meta{color:#94a3b8;}
  .row .title-text{font-size:16px;font-weight:600;color:#0f172a;margin-bottom:4px}
  body[data-theme="dark"] .row .title-text{color:#f1f5f9;}
  .tag{
    padding:4px 10px;border-radius:999px;border:none;
    font-size:12px;font-weight:500;
    display:inline-flex;align-items:center;gap:4px;
  }
  .tag.type-tag{
    background:#f1f5f9;color:#64748b;
  }
  body[data-theme="dark"] .tag.type-tag{
    background:#475569;color:#cbd5e1;
  }
  .tag.pending{
    background:#dbeafe;color:#1e40af;
    font-weight:600;
  }
  body[data-theme="dark"] .tag.pending{
    background:rgba(59,130,246,.2);color:#93c5fd;
  }
  .tag.changes{
    background:#fed7aa;color:#ea580c;
    font-weight:600;
  }
  body[data-theme="dark"] .tag.changes{
    background:rgba(249,115,22,.2);color:#fb923c;
  }
  .tag.approved{
    background:#d1fae5;color:#047857;
    font-weight:600;
  }
  body[data-theme="dark"] .tag.approved{
    background:rgba(34,197,94,.2);color:#6ee7b7;
  }
  .tag.low-priority{
    background:#f1f5f9;color:#64748b;
  }
  body[data-theme="dark"] .tag.low-priority{
    background:#475569;color:#94a3b8;
  }
  .action-button{
    display:inline-flex;align-items:center;gap:6px;
    padding:8px 16px;border-radius:8px;
    background:#2563eb;color:#ffffff;
    border:none;font-size:13px;font-weight:600;
    cursor:pointer;transition:all 0.2s;
    box-shadow:0 2px 4px rgba(37,99,235,.2);
  }
  .action-button:hover{
    background:#1d4ed8;box-shadow:0 4px 8px rgba(37,99,235,.3);
    transform:translateY(-1px);
  }
  .arrow-icon{
    width:20px;height:20px;stroke:#2563eb;stroke-width:2;
    flex-shrink:0;
  }
  body[data-theme="dark"] .arrow-icon{stroke:#60a5fa;}
  .muted{color:var(--muted)}
  .timeline{position:relative;padding-left:18px}
  .timeline:before{content:"";position:absolute;left:6px;top:4px;bottom:8px;width:2px;background:linear-gradient(180deg,#313749,transparent)}
  .tl-item{position:relative;margin:10px 0;padding-left:8px}
  .tl-item:before{content:"";position:absolute;left:-12px;top:6px;width:8px;height:8px;border-radius:50%;background:var(--brand)}
  .form{display:grid;gap:12px}
  .cols-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .form input, .form select, .form textarea{
    width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;
    background:#ffffff;color:#0f172a;font-size:14px;font-family:inherit;
    transition:all 0.2s;
  }
  .form input:focus, .form select:focus, .form textarea:focus{
    outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.1);
  }
  body[data-theme="dark"] .form input, body[data-theme="dark"] .form select, body[data-theme="dark"] .form textarea{
    background:#1e293b;border-color:#334155;color:#f1f5f9;
  }
  body[data-theme="dark"] .form input:focus, body[data-theme="dark"] .form select:focus, body[data-theme="dark"] .form textarea:focus{
    border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.2);
  }
  .submit-request-btn:hover{
    background:#f1f5f9 !important;box-shadow:0 2px 4px rgba(0,0,0,.1);transform:translateY(-1px);
  }
  .submit-request-btn:active{
    transform:translateY(0);
  }
  #approveBtn:hover{background:#16a34a !important;box-shadow:0 4px 8px rgba(34,197,94,.3);transform:translateY(-1px);}
  #requestChangesBtn:hover{background:#ea580c !important;box-shadow:0 4px 8px rgba(249,115,22,.3);transform:translateY(-1px);}
  #deleteApprovalBtn:hover{background:#dc2626 !important;box-shadow:0 4px 8px rgba(239,68,68,.3);transform:translateY(-1px);}
  #approveBtn:active, #requestChangesBtn:active, #deleteApprovalBtn:active{transform:translateY(0);}
  footer{margin:24px 0 8px;color:var(--muted);font-size:12px;text-align:center}
  
  .lane-head{display:flex;align-items:center;gap:10px;margin:2px 0 8px}
  /* Calendar */
  .calendar-section{background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:16px;padding:24px;margin-top:24px;}
  body[data-theme="dark"] .calendar-section{background:linear-gradient(135deg, #0e1b2e 0%, #1a1f35 100%);}
  .calendar-month-group{margin-bottom:32px;}
  .calendar-month-header{
    font-size:18px;font-weight:700;color:#ffffff;
    margin-bottom:16px;padding:12px 20px;
    border-radius:12px;text-transform:uppercase;
    letter-spacing:1px;box-shadow:0 2px 4px rgba(0,0,0,.1);
  }
  .calendar-month-header.month-0{background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);}
  .calendar-month-header.month-1{background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);}
  .calendar-month-header.month-2{background:linear-gradient(135deg, #ec4899 0%, #db2777 100%);}
  .calendar-month-header.month-3{background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);}
  .calendar-month-header.month-4{background:linear-gradient(135deg, #10b981 0%, #059669 100%);}
  .calendar-month-header.month-5{background:linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);}
  .calendar-month-header.month-6{background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);}
  .calendar-month-header.month-7{background:linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);}
  .calendar-month-header.month-8{background:linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);}
  .calendar-month-header.month-9{background:linear-gradient(135deg, #f97316 0%, #ea580c 100%);}
  .calendar-month-header.month-10{background:linear-gradient(135deg, #a855f7 0%, #9333ea 100%);}
  .calendar-month-header.month-11{background:linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;z-index:60;align-items:center;justify-content:center;padding:20px;overflow-y:auto;}
  .modal.show{display:flex !important;}
  .modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);}
  .modal__panel{position:relative;max-width:720px;width:100%;max-height:90vh;overflow-y:auto;background:#ffffff;border:none;
                border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:24px;animation:slideUp 0.3s ease-out;}
  @keyframes slideUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
  body[data-theme="dark"] .modal__panel{background:#151821;box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .approval-modal-panel{max-width:600px;}
  .approval-modal-body{margin:0;}
  .modal__head,.modal__foot{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:20px;}
  .modal__foot{margin-bottom:0;margin-top:20px;}
  .modal__body textarea{width:100%;background:#ffffff;border:1px solid #e2e8f0;border-radius:8px;color:#0f172a;padding:12px;font-size:14px;font-family:inherit;resize:vertical;}
  body[data-theme="dark"] .modal__body textarea{background:#1e293b;border-color:#334155;color:#f1f5f9;}
  @media (max-width: 960px){ .cards{grid-template-columns:1fr 1fr} .grid{grid-template-columns:1fr} }

/* --- TOKENS --- */
:root{
  --surface:#f1f3f5; --surface-2:#ffffff;
  --success:#22c55e; --warning:#facc15; --danger:#f87171;
  --accent1:#8b5cf6; --accent2:#60a5fa;
  --radius-lg:20px; --radius-md:14px; --shadow-md:0 6px 24px rgba(0,0,0,.25);
}
body[data-theme="dark"]{
  --surface:#151821; --surface-2:#0f1117;
}

/* --- OVERVIEW GRID --- */
.overview{
  display:grid; gap:16px;
  grid-template-columns: repeat(12, 1fr);
}
  .kpi-card{
  grid-column: span 4; /* 3 cards per row on desktop */
  background: #ffffff;
  border:none;
  border-radius: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
  padding:20px;
  position:relative; overflow:hidden;
}
body[data-theme="dark"] .kpi-card{
  background: #1e293b;
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
}
.kpi-card .label{ 
  font-size:14px; 
  color:#64748b; 
  margin-bottom:8px; 
  display:flex; 
  align-items:center; 
  gap:8px;
  font-weight:500;
}
.kpi-card .value{ 
  font-size:36px; 
  font-weight:800; 
  letter-spacing:-.5px; 
  margin:8px 0 12px;
  color:#0f172a;
}
body[data-theme="dark"] .kpi-card .value{color:#f1f5f9;}
.kpi-card .sub{ 
  font-size:13px; 
  color:#64748b; 
  display:flex;
  align-items:center;
  gap:8px;
}
.kpi-card .pill{
  display:inline-flex; 
  align-items:center; 
  gap:4px;
  padding:6px 12px; 
  border-radius:999px; 
  font-size:12px;
  font-weight:600;
  border:none;
}
.kpi-card.success .pill{ 
  background: #dbeafe; 
  color: #1e40af;
}
body[data-theme="dark"] .kpi-card.success .pill{
  background: rgba(59,130,246,.2);
  color: #93c5fd;
}
.kpi-card.warning .pill{ 
  background: #fed7aa; 
  color: #ea580c;
}
body[data-theme="dark"] .kpi-card.warning .pill{
  background: rgba(249,115,22,.2);
  color: #fb923c;
}
.kpi-card.danger  .pill{ 
  background: #fecdd3; 
  color: #be123c;
}
body[data-theme="dark"] .kpi-card.danger .pill{
  background: rgba(236,72,153,.2);
  color: #f9a8d4;
}

.kpi-card .icon{
  width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
  background:var(--surface-2); border:1px solid var(--stroke); color:var(--text);
}
.kpi-card.success .icon{ box-shadow: 0 0 0 2px rgba(34,197,94,.25) inset }
.kpi-card.warning .icon{ box-shadow: 0 0 0 2px rgba(250,204,21,.25) inset }
.kpi-card.danger  .icon{ box-shadow: 0 0 0 2px rgba(248,113,113,.25) inset }

  .kpi-card.motivation{
  background: linear-gradient(180deg, rgba(139,92,246,.08), rgba(96,165,250,.04));
}
body[data-theme="dark"] .kpi-card.motivation{
  background:
    linear-gradient(180deg, rgba(139,92,246,.10), rgba(96,165,250,.06)),
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
}
.motivation .quote{ font-size:15px; line-height:1.5; }
.motivation .small{ font-size:12px; color:var(--muted); margin-top:8px }

@media (max-width: 1024px){
  .kpi-card{ grid-column: span 6; } /* 2 per row on tablet */
}
@media (max-width: 640px){
  .kpi-card{ grid-column: span 12; } /* stack on mobile */
}


</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div id="clientLogoContainer" class="profile-logo-container" style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid rgba(255,255,255,0.3); flex-shrink: 0; border-radius: 0;">
          <img id="clientLogoImg" src="" alt="Client Logo" style="max-width: 60px; max-height: 60px; width: auto; height: auto; object-fit: contain; display: none;">
          <span id="clientLogoInitials" style="font-size: 24px; font-weight: 700; color: white; text-transform: uppercase;">CN</span>
        </div>
        <div class="title">
          <h1 id="clientName">Loading...</h1>
          <div class="sub">Real-time status ‚Ä¢ Approvals ‚Ä¢ Requests</div>
        </div>
      </div>
      <div class="actions">
        <div class="notification-icon" id="notificationBtn" aria-label="Notifications">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
        </div>
        <a href="#" class="logout-link" id="logoutBtn" onclick="handleLogout(event); return false;">Logout</a>
        <button class="btn small" id="toggleMode" style="display:none">‚òÄÔ∏è</button>
      </div>
    </header>

    <section class="panel section-overview" style="margin-top:24px;background:#ffffff;border-radius:16px;padding:24px;box-shadow:none;border:none;">
      <h3 style="font-size:18px;font-weight:700;color:#1e40af;margin:0 0 20px 0;">Overview</h3>

      <div class="overview" id="overviewRow">

        <!-- Posts scheduled -->

        <div class="kpi-card success" id="cardScheduled">

          <div class="label">

            <span class="icon">üìÖ</span>

            <span>Posts scheduled (next 15 days)</span>

          </div>

          <div class="value" id="kpiValScheduled">0</div>

          <div class="sub">

            <span class="pill" id="kpiSubScheduled">On track</span>

          </div>

        </div>

        <!-- Waiting for your approval -->

        <div class="kpi-card warning" id="cardApproval">

          <div class="label">

            <span class="icon">üìù</span>

            <span>Waiting for your approval</span>

          </div>

          <div class="value" id="kpiValApproval">0</div>

          <div class="sub">

            <span class="pill" id="kpiSubApproval">Needs review</span>

          </div>

        </div>

        <!-- Approved for... -->

        <div class="kpi-card" id="cardMissing" style="background:linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);">

          <div class="label">

            <span class="icon">‚úÖ</span>

            <span>Approved for publication</span>

          </div>

          <div class="value" id="kpiValMissing">0</div>

          <div class="sub">

            <span class="pill" id="kpiSubMissing" style="background:#fbcfe8;color:#be185d;">Ready</span>

          </div>

        </div>

      </div>

    </section>

    <!-- Approvals -->
    <section class="panel section-approvals" id="approvalsPanel" style="margin-top:24px">
      <h3 style="font-size:18px;font-weight:700;color:#ffffff;margin:0 0 20px 0;">Approvals Queue</h3>
      <div class="approval-tabs" id="approvalTabs">
        <button class="approval-tab active" data-tab="pending">Pending</button>
        <button class="approval-tab" data-tab="changes">Changes</button>
        <button class="approval-tab" data-tab="approved">Approved</button>
      </div>
      <div class="lane lane-pending" id="lanePending" style="display:block;">
        <div id="approvalsPending" class="list"></div>
      </div>
      <div class="lane lane-changes" id="laneChanges" style="display:none">
        <div id="approvalsChanges" class="list"></div>
      </div>
      <div class="lane lane-approved" id="laneApproved" style="display:none">
        <div id="approvalsApproved" class="list"></div>
      </div>
    </section>

    <div class="grid" style="margin-top:16px">
      <!-- What we need + Quick Request -->
      <section class="panel section-requests" style="grid-column: span 6;">
        <h3 style="font-size:18px;font-weight:700;color:#ffffff;margin:0 0 20px 0;">What We Need From You</h3>
        <div id="needs" class="list"></div>
        <hr style="border-color:rgba(255,255,255,.2);border-top:1px solid rgba(255,255,255,.2);margin:20px 0;">
        <h3 style="font-size:18px;font-weight:700;color:#ffffff;margin:0 0 20px 0;">Quick Request</h3>
        <form id="requestForm" class="form form-quick-request" autocomplete="off">
          <div class="cols-2">
            <select id="reqType" required>
              <option value="">Select type‚Ä¶</option>
              <option>Send photos/videos</option>
              <option>Approve content</option>
              <option>Ask for changes</option>
              <option>New campaign idea</option>
              <option>Other</option>
            </select>
            <input id="reqContact" type="text" placeholder="Your name (optional)">
          </div>
          <textarea id="reqDetails" rows="4" placeholder="Describe your request‚Ä¶"></textarea>
          <div class="cols-2">
            <input id="reqLink" type="text" placeholder="Link to files (Drive/WeTransfer)">
            <button class="btn primary submit-request-btn" type="submit" style="background:#ffffff;color:#0f172a;border:1px solid #e2e8f0;font-weight:600;transition:all 0.2s ease;">Submit request</button>
          </div>
          <small style="color:rgba(255,255,255,.8);font-size:12px;display:block;margin-top:8px;">Requests appear instantly in "Open Requests" and are saved to your browser (demo).</small>
        </form>
        
        <!-- Request Stats -->
        <div class="request-stats" style="margin-top:24px;display:grid;grid-template-columns:1fr 1fr;gap:20px;">
          <div class="stat-circle">
            <div class="stat-title">Request From clients</div>
            <div class="circular-progress" id="completedProgress">
              <svg class="progress-ring" width="120" height="120">
                <circle class="progress-ring-background" cx="60" cy="60" r="50" fill="none" stroke="#e0e7ff" stroke-width="8"/>
                <circle class="progress-ring-fill" id="completedRing" cx="60" cy="60" r="50" fill="none" stroke="#1e40af" stroke-width="8" stroke-linecap="round" transform="rotate(-90 60 60)"/>
              </svg>
              <div class="progress-content">
                <div class="progress-value" id="completedPercent">0%</div>
              </div>
            </div>
            <div class="stat-label">Completed</div>
          </div>
          
          <div class="stat-circle">
            <div class="stat-title">What we need from you</div>
            <div class="circular-progress" id="needsProgress">
              <svg class="progress-ring" width="120" height="120">
                <circle class="progress-ring-background" cx="60" cy="60" r="50" fill="none" stroke="#e0e7ff" stroke-width="8"/>
                <circle class="progress-ring-fill" id="needsRing" cx="60" cy="60" r="50" fill="none" stroke="#1e40af" stroke-width="8" stroke-linecap="round" transform="rotate(-90 60 60)"/>
              </svg>
              <div class="progress-content">
                <div class="progress-value" id="needsPercent">0%</div>
              </div>
            </div>
            <div class="stat-label">Completed</div>
          </div>
        </div>
      </section>

      <!-- Open Requests -->
      <section class="panel section-requests" style="grid-column: span 6;">
        <h3 style="font-size:18px;font-weight:700;color:#ffffff;margin:0 0 8px 0;">Open Requests</h3>
        <p style="font-size:13px;color:rgba(255,255,255,0.8);margin:0 0 20px 0;">Most requests are resolved within 1‚Äì3 business days.</p>
        <div id="requests" class="list"></div>
      </section>

      <!-- Recent Activity -->
      <section class="panel" style="grid-column: span 12;">
        <h3>Recent Activity</h3>
        <div class="timeline" id="timeline"></div>
      </section>

      <!-- Calendar -->
      <section class="panel calendar-section" style="grid-column: span 12;background:transparent;border:none;box-shadow:none;padding:0;">
        <h3 style="font-size:18px;font-weight:700;color:#1e40af;margin:0 0 20px 0;">Calendar</h3>
        <div id="calendarView"></div>
      </section>

      <!-- Reports -->
      <section class="panel section-reports" id="reports" style="grid-column: span 12;">
        <h3>üìà Marketing Performance Report</h3>
        <div class="cards">
          <div class="card">
            <div class="label">Ads Overview</div>
            <div class="metric" id="r-ads-running">‚Äî</div>
            <small class="muted" id="r-ads-sub">‚Äî</small>
            <div class="chip ok" id="r-ads-chip">Performing well</div>
          </div>
          <div class="card">
            <div class="label">Google & Social Growth</div>
            <div class="metric" id="r-growth-score">‚Äî</div>
            <small class="muted" id="r-growth-sub">‚Äî</small>
            <div class="chip ok" id="r-growth-chip">Visibility up</div>
          </div>
          <div class="card">
            <div class="label">This Month‚Äôs Work</div>
            <ul id="r-work-list" style="margin:8px 0 0 16px"></ul>
            <small class="muted" id="r-work-sub">‚Äî</small>
          </div>
          <div class="card">
            <div class="label">Highlights</div>
            <p class="muted" id="r-summary">‚Äî</p>
          </div>
        </div>

        <!-- Admin mini form -->
        <div id="reportsAdmin" class="panel" style="margin-top:12px; display:none">
          <h3>Update Report (Team)</h3>
          <form id="reportsForm" class="form">
            <div class="cols-2"><input type="password" id="repPin" placeholder="Team PIN" /><input type="text" id="repPeriod" placeholder="Period (e.g., Nov 2025)" /></div>
            <div class="cols-2"><input type="number" id="repAdsRunning" placeholder="Ads running" /><input type="number" id="repImpressions" placeholder="Impressions" /></div>
            <div class="cols-2"><input type="number" id="repClicks" placeholder="Clicks" /><input type="number" id="repLeads" placeholder="Leads" /></div>
            <div class="cols-2"><input type="number" id="repGmbViews" placeholder="GMB views" /><input type="number" id="repProfileSearches" placeholder="Profile searches" /></div>
            <div class="cols-2"><input type="number" id="repWebsiteClicks" placeholder="Website clicks" /><input type="number" id="repIgFollowers" placeholder="IG followers change" /></div>
            <div class="cols-2"><input type="number" id="repPosts" placeholder="Posts published" /><input type="number" id="repReels" placeholder="Reels edited" /></div>
            <div class="cols-2"><input type="number" id="repCampaigns" placeholder="Campaigns launched" /><input type="number" id="repRequests" placeholder="Requests resolved" /></div>
            <div class="cols-2"><button class="btn" type="button" id="cancelReports">Cancel</button><button class="btn primary" type="submit">Save Report</button></div>
            <small class="muted">This MVP saves to your browser (localStorage). APIs later.</small>
          </form>
        </div>
      </section>
    </div>

    <footer>¬© 2Fly Marketing ‚Äî MVP (localStorage). Ready for ClickUp/Meta/GMB later.</footer>
  </div>


  <!-- Approval Modal -->
  <div id="approvalModal" class="modal" aria-hidden="true">
    <div class="modal__backdrop" data-close-modal></div>
    <div class="modal__panel approval-modal-panel" role="dialog" aria-modal="true">
      <div class="modal__head">
        <h4 id="approvalTitle" style="font-size:20px;font-weight:700;color:#1e40af;">Approval Details</h4>
        <button type="button" id="closeModalBtn" class="btn small" data-close-modal style="background:transparent;border:none;font-size:28px;color:#64748b;cursor:pointer;line-height:1;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">&times;</button>
      </div>
      <div class="modal__body approval-modal-body">
        <!-- Image Preview -->
        <div id="approvalImageContainer" style="width:100%;margin-bottom:20px;border-radius:12px;overflow:hidden;background:#f1f5f9;min-height:300px;display:flex;align-items:center;justify-content:center;">
          <img id="approvalImage" src="" alt="Content preview" style="width:100%;height:auto;display:block;max-height:500px;object-fit:contain;">
        </div>
        
        <!-- Instagram Link -->
        <div style="margin-bottom:20px;">
          <a id="approvalInstagramLink" href="#" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;color:#1e40af;text-decoration:none;font-weight:500;font-size:14px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
            </svg>
            <span>View on Instagram</span>
          </a>
        </div>
        
        <!-- Caption -->
        <div style="margin-bottom:20px;">
          <h5 style="font-size:14px;font-weight:600;color:#1e40af;margin-bottom:8px;">Caption:</h5>
          <div id="approvalCaption" style="background:#f8fafc;padding:16px;border-radius:8px;border:1px solid #e2e8f0;color:#0f172a;line-height:1.6;white-space:pre-wrap;font-size:14px;"></div>
        </div>
        
        <!-- Change Request Notes (shown only for items with status "changes") -->
        <div id="changeRequestContainer" style="display:none;margin-bottom:20px;">
          <h5 style="font-size:14px;font-weight:600;color:#ea580c;margin-bottom:8px;">Change Request:</h5>
          <div id="changeRequestNotes" style="background:#fff7ed;padding:16px;border-radius:8px;border:1px solid #fed7aa;color:#9a3412;line-height:1.6;white-space:pre-wrap;font-size:14px;"></div>
        </div>
        
        <!-- Request Changes Form (hidden by default) -->
        <div id="changesFormContainer" style="display:none;margin-bottom:20px;padding:16px;background:#fff7ed;border-radius:8px;border:1px solid #fed7aa;">
          <label style="display:block;font-size:14px;font-weight:600;color:#ea580c;margin-bottom:8px;">Describe what needs to be changed:</label>
          <textarea id="changesText" rows="4" placeholder="Please provide specific details about what needs to be changed..." style="width:100%;padding:12px;border:1px solid #fed7aa;border-radius:8px;font-size:14px;font-family:inherit;resize:vertical;"></textarea>
          <button type="button" id="submitChangesBtn" class="btn submit-changes-btn" style="background:#f97316;color:#ffffff;border:none;margin-top:12px;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;width:100%;transition:all 0.2s;">Submit Changes</button>
        </div>
      </div>
      <div class="modal__foot" style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:1px solid #e2e8f0;flex-wrap:wrap;">
        <button type="button" class="btn" id="cancelChangesBtn" data-close-modal style="display:none;background:#f1f5f9;color:#64748b;border:1px solid #e2e8f0;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
        <button type="button" class="btn" id="deleteApprovalBtn" style="background:#ef4444;color:#ffffff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;">Delete</button>
        <button type="button" class="btn" id="requestChangesBtn" style="background:#f97316;color:#ffffff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;">Request Change</button>
        <button type="button" class="btn" id="approveBtn" style="background:#22c55e;color:#ffffff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;">Approve</button>
      </div>
    </div>
  </div>

<script>
/* ================== Authentication ================== */
const LS_SESSION_KEY = "2fly_client_session";
const LS_CLIENTS_KEY = "2fly_clients_v1";

// Logout functionality - define early so it's available for onclick
window.handleLogout = function(e) {
  if (e) {
    e.preventDefault();
    e.stopPropagation();
  }
  console.log("Logout clicked - clearing session");
  // Clear session from localStorage
  localStorage.removeItem(LS_SESSION_KEY);
  console.log("Session cleared, redirecting to login...");
  // Redirect to login page
  window.location.href = 'login.html';
};

function checkAuth() {
  const session = localStorage.getItem(LS_SESSION_KEY);
  if (!session) {
    window.location.href = 'login.html';
    return null;
  }
  
  try {
    const sessionData = JSON.parse(session);
    // Check if session is still valid (24 hours)
    if (Date.now() - sessionData.loggedInAt > 24 * 60 * 60 * 1000) {
      localStorage.removeItem(LS_SESSION_KEY);
      window.location.href = 'login.html';
      return null;
    }
    return sessionData;
  } catch {
    localStorage.removeItem(LS_SESSION_KEY);
    window.location.href = 'login.html';
    return null;
  }
}

// Check authentication on page load
const session = checkAuth();
if (!session) {
  // Redirect will happen, stop execution
  throw new Error('Not authenticated');
}

// Debug logging
console.log("Session loaded:", session);
console.log("Client ID:", session.clientId);
console.log("Client Name:", session.clientName);

// Get client ID from session - normalize to lowercase for consistency
const currentClientId = (session.clientId || "").toLowerCase().trim();

// Immediately update the client name in the DOM if available (before any other code runs)
if (session.clientName) {
  const clientNameEl = document.getElementById("clientName");
  if (clientNameEl) {
    clientNameEl.textContent = session.clientName;
    console.log("Client name set immediately to:", session.clientName);
  }
}

// Function to load client logo from agency registry
function loadClientLogo() {
  try {
    const session = checkAuth();
    if (!session || !session.clientId) {
      // Show initials as fallback
      const logoInitials = document.getElementById("clientLogoInitials");
      if (logoInitials) {
        logoInitials.style.display = "block";
        logoInitials.textContent = "CN";
      }
      return;
    }
    
    // Get client data from agency registry
    const LS_CLIENTS_KEY = "2fly_agency_clients_v1";
    const clientsData = localStorage.getItem(LS_CLIENTS_KEY);
    if (!clientsData) {
      // Fallback to initials
      const logoInitials = document.getElementById("clientLogoInitials");
      if (logoInitials) {
        logoInitials.style.display = "block";
        const clientName = session.clientName || "CN";
        const initials = clientName.split(" ").map(word => word.charAt(0)).join("").substring(0, 2).toUpperCase();
        logoInitials.textContent = initials || "CN";
      }
      return;
    }
    
    const clients = JSON.parse(clientsData);
    const clientId = session.clientId.toLowerCase();
    const client = clients[clientId];
    
    const logoImg = document.getElementById("clientLogoImg");
    const logoInitials = document.getElementById("clientLogoInitials");
    
    if (client && client.logoUrl) {
      // Show logo
      if (logoImg) {
        logoImg.src = client.logoUrl;
        logoImg.style.display = "block";
      }
      if (logoInitials) {
        logoInitials.style.display = "none";
      }
    } else {
      // Show initials
      if (logoImg) {
        logoImg.style.display = "none";
      }
      if (logoInitials) {
        logoInitials.style.display = "block";
        const clientName = session.clientName || (client ? client.name : "CN");
        const initials = clientName.split(" ").map(word => word.charAt(0)).join("").substring(0, 2).toUpperCase();
        logoInitials.textContent = initials || "CN";
      }
    }
  } catch(e) {
    console.warn("Error loading client logo:", e);
    // Fallback to initials if error
    const logoInitials = document.getElementById("clientLogoInitials");
    if (logoInitials) {
      logoInitials.style.display = "block";
      try {
        const session = checkAuth();
        const clientName = session ? (session.clientName || "CN") : "CN";
        const initials = clientName.split(" ").map(word => word.charAt(0)).join("").substring(0, 2).toUpperCase();
        logoInitials.textContent = initials || "CN";
      } catch(e2) {
        logoInitials.textContent = "CN";
      }
    }
  }
}

// Load logo on page load
loadClientLogo();

// Function to load client logo from agency registry
function loadClientLogo() {
  try {
    const session = checkAuth();
    if (!session || !session.clientId) return;
    
    // Get client data from agency registry
    const LS_CLIENTS_KEY = "2fly_agency_clients_v1";
    const clientsData = localStorage.getItem(LS_CLIENTS_KEY);
    if (!clientsData) return;
    
    const clients = JSON.parse(clientsData);
    const clientId = session.clientId.toLowerCase();
    const client = clients[clientId];
    
    if (!client) return;
    
    const logoImg = document.getElementById("clientLogoImg");
    const logoInitials = document.getElementById("clientLogoInitials");
    
    if (client.logoUrl) {
      // Show logo
      if (logoImg) {
        logoImg.src = client.logoUrl;
        logoImg.style.display = "block";
      }
      if (logoInitials) {
        logoInitials.style.display = "none";
      }
    } else {
      // Show initials
      if (logoImg) {
        logoImg.style.display = "none";
      }
      if (logoInitials) {
        logoInitials.style.display = "block";
        const clientName = session.clientName || client.name || "CN";
        const initials = clientName
          .split(" ")
          .map(word => word.charAt(0))
          .join("")
          .substring(0, 2)
          .toUpperCase();
        logoInitials.textContent = initials || "CN";
      }
    }
  } catch(e) {
    console.warn("Error loading client logo:", e);
    // Fallback to initials if error
    const logoInitials = document.getElementById("clientLogoInitials");
    if (logoInitials) {
      logoInitials.style.display = "block";
      try {
        const session = checkAuth();
        const clientName = session ? (session.clientName || "CN") : "CN";
        const initials = clientName
          .split(" ")
          .map(word => word.charAt(0))
          .join("")
          .substring(0, 2)
          .toUpperCase();
        logoInitials.textContent = initials || "CN";
      } catch(e2) {
        logoInitials.textContent = "CN";
      }
    }
  }
}

// Normalize clientId to lowercase for consistency with agency dashboard
if (session.clientId) {
  session.clientId = session.clientId.toLowerCase().trim();
}

/* ================== State (localStorage) ================== */
const LS_KEY = `client_portal_${currentClientId}_v1`;
console.log("Using localStorage key:", LS_KEY);

// Load state from localStorage
function load() {
  try {
    const d = localStorage.getItem(LS_KEY);
    console.log("Loading from key:", LS_KEY, "Data exists:", !!d);
    if (!d) {
      // Initialize with seed data if doesn't exist
      const seed = getSeed();
      localStorage.setItem(LS_KEY, JSON.stringify(seed));
      console.log("Initialized new state for client:", currentClientId);
      return seed;
    }
    const state = JSON.parse(d);
    console.log("Loaded state, approvals count:", (state.approvals || []).length);
    // Ensure all required properties exist
    if (!state.client) state.client = { id: currentClientId, name: session.clientName || "Client", whatsapp: "" };
    if (!state.approvals) state.approvals = [];
    if (!state.needs) state.needs = [];
    if (!state.requests) state.requests = [];
    if (!state.activity) state.activity = [];
    if (!state.kpis) state.kpis = { scheduled: 0, waitingApproval: 0, missingAssets: 0, frustration: 0 };
    return state;
  } catch(e) {
    console.error("Error loading state:", e);
    // Return seed data on error
    const seed = getSeed();
    localStorage.setItem(LS_KEY, JSON.stringify(seed));
    return seed;
  }
}

// Save state to localStorage
function save(state) {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    console.log("State saved to:", LS_KEY);
  } catch(e) {
    console.error("Error saving state:", e);
  }
}

function getSeed() {
  // Return empty seed data for new clients - they should start fresh
  return {
    client:{ id: currentClientId, name: session.clientName || "Client", whatsapp:"" },
    kpis:{ scheduled:0, waitingApproval:0, missingAssets:0, frustration:0 },
    approvals:[],
    needs:[],
    requests:[],
    assets:[],
    activity:[],
    seen:false
  };
}

/* ---- MIGRATION: ensure approvals exist (if state was wiped) ---- */
function migrateState(){
  const s = load(); let changed = false;
  
  // Always sync client name from session to ensure it's up to date
  let currentSession = null;
  try {
    currentSession = checkAuth();
  } catch(e) {
    console.warn("Could not get session in migrateState:", e);
  }
  
  if (currentSession && currentSession.clientName) {
    if (!s.client) {
      s.client = { id: currentSession.clientId, name: currentSession.clientName, whatsapp: "" };
      changed = true;
    } else {
      if (s.client.name !== currentSession.clientName) {
        s.client.name = currentSession.clientName;
        changed = true;
      }
      // Also update client ID if it doesn't match
      if (s.client.id !== currentSession.clientId) {
        s.client.id = currentSession.clientId;
        changed = true;
      }
    }
  } else if (typeof session !== 'undefined' && session && session.clientName) {
    // Fallback to global session variable
    if (!s.client) {
      s.client = { id: session.clientId, name: session.clientName, whatsapp: "" };
      changed = true;
    } else {
      if (s.client.name !== session.clientName) {
        s.client.name = session.clientName;
        changed = true;
      }
      if (s.client.id !== session.clientId) {
        s.client.id = session.clientId;
        changed = true;
      }
    }
  }
  
  // Ensure approvals array exists (start empty for new clients)
  if(!Array.isArray(s.approvals)){
    s.approvals = [];
    changed = true;
  }
  
  // Update pending count
  if (s.approvals) {
    const pendingCount = s.approvals.filter(a => !a.status || a.status === 'pending').length;
    if(s.kpis && typeof s.kpis.waitingApproval==="number"){ 
      s.kpis.waitingApproval = pendingCount; 
      changed = true;
    }
  }
  
  // Ensure client name is always synced from session (important for client name display)
  if (session && session.clientName) {
    if (!s.client) s.client = { id: session.clientId, name: session.clientName, whatsapp: "" };
    if (s.client.name !== session.clientName || s.client.id !== session.clientId) {
      s.client.name = session.clientName;
      s.client.id = session.clientId;
      changed = true;
    }
  }
  
  // Ensure requests array exists (start empty for new clients)
  if(!Array.isArray(s.requests)){
    s.requests = [];
    changed = true;
  } else {
    // Migrate completedAt to doneAt for backward compatibility
    s.requests.forEach(r => {
      if (r.completedAt && !r.doneAt) {
        r.doneAt = r.completedAt;
        delete r.completedAt;
        changed = true;
      }
      // Ensure createdAt exists for all requests
      if (!r.createdAt) {
        r.createdAt = Date.now();
        changed = true;
      }
    });
  }
  // Ensure needs array exists (start empty for new clients)
  if (!Array.isArray(s.needs)) {
    s.needs = [];
    changed = true;
  } else {
    // Migrate old needs to have status field
    s.needs.forEach(n => {
      if (!n.status) {
        n.status = 'open';
        changed = true;
      }
    });
  }
  
  // Ensure activity array exists (start empty for new clients)
  if(!Array.isArray(s.activity)){
    s.activity = [];
    changed = true;
  }
  
  // Ensure assets array exists (start empty for new clients)
  if(!Array.isArray(s.assets)){
    s.assets = [];
    changed = true;
  }
  if(changed) save(s);
}
migrateState();

/* ================== Helpers ================== */
const $ = sel => document.querySelector(sel);
const el = (tag, attrs={}, ...kids) => { const node=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==='class') node.className=v; else if(k==='html') node.innerHTML=v; else node.setAttribute(k,v); }); kids.forEach(k=>node.append(k)); return node; };
const fmtDate = ts => new Date(ts).toLocaleString([], {month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});

// Calculate scheduled posts (approvals with postDate within next 15 days)
function calculateScheduledPosts(approvals) {
  if (!approvals || !Array.isArray(approvals)) return 0;
  
  const now = new Date();
  const fifteenDaysFromNow = new Date(now);
  fifteenDaysFromNow.setDate(now.getDate() + 15);
  
  return approvals.filter(a => {
    if (!a.postDate) return false;
    const postDate = new Date(a.postDate);
    // Include posts scheduled for today and within the next 15 days
    return postDate >= now && postDate <= fifteenDaysFromNow;
  }).length;
}

/* ================== Notifications (optional webhook) ================== */
const WEBHOOK_URL = ""; // add Make/Zapier URL later
async function notifyTeam(payload){
  const s = load(); s.activity.push({ when: Date.now(), text: payload.activityText || "Client action" }); save(s); // log activity
  if(!WEBHOOK_URL) return;
  try{ await fetch(WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}); }catch(e){ console.warn("Webhook failed:", e); }
}

/* ================== Base Render ================== */
function render(){
  const state = load();
  
  // Always use session clientName as source of truth, fallback to state
  const clientNameEl = $("#clientName");
  if (clientNameEl) {
    // Get current session fresh (it might have been refreshed)
    let currentSession = null;
    try {
      currentSession = checkAuth();
    } catch(e) {
      console.warn("Could not get session in render:", e);
    }
    
    // Try to get display name from multiple sources
    let displayName = "Client";
    if (currentSession && currentSession.clientName) {
      displayName = currentSession.clientName;
    } else if (typeof session !== 'undefined' && session && session.clientName) {
      displayName = session.clientName;
    } else if (state && state.client && state.client.name) {
      displayName = state.client.name;
    }
    
    clientNameEl.textContent = displayName;
    console.log("Client name set to:", displayName);
    
    // Update state if it's different (for consistency)
    if (currentSession && currentSession.clientName && state.client.name !== currentSession.clientName) {
      state.client.name = currentSession.clientName;
      save(state);
    } else if (typeof session !== 'undefined' && session && session.clientName && state.client.name !== session.clientName) {
      state.client.name = session.clientName;
      save(state);
    }
  }
  
  // Load and display client logo
  loadClientLogo();
  
  const lastSyncEl = $("#lastSync");
  if (lastSyncEl) lastSyncEl.textContent = "updated " + fmtDate(Date.now());

  // KPIs
  // Calculate scheduled posts from approvals with postDate within next 15 days
  const scheduledCount = calculateScheduledPosts(state.approvals || []);
  // Update state to keep it in sync with agency dashboard
  if (state.kpis) {
    state.kpis.scheduled = scheduledCount;
    save(state);
  }
  
  const kpiValScheduled = $("#kpiValScheduled");
  if (kpiValScheduled) kpiValScheduled.textContent = scheduledCount;
  
  // Count pending approvals from the actual approvals array
  const pendingCount = (state.approvals || []).filter(a => !a.status || a.status === 'pending').length;
  const kpiValApproval = $("#kpiValApproval");
  if (kpiValApproval) kpiValApproval.textContent = pendingCount;
  
  // Update state for consistency
  if (state.kpis) state.kpis.waitingApproval = pendingCount;
  
  // Count approved items for the third card
  const approvedCount = (state.approvals || []).filter(a => a.status === 'approved').length;
  const kpiValMissing = $("#kpiValMissing");
  if (kpiValMissing) kpiValMissing.textContent = approvedCount;
  
  const kpiSubScheduled = $("#kpiSubScheduled");
  if (kpiSubScheduled) kpiSubScheduled.textContent = state.kpis.scheduled >= 14 ? "On track" : "Low coverage";
  
  const kpiSubApproval = $("#kpiSubApproval");
  if (kpiSubApproval) kpiSubApproval.textContent = pendingCount > 0 ? "Needs review" : "All clear";
  
  const kpiSubMissing = $("#kpiSubMissing");
  if (kpiSubMissing) kpiSubMissing.textContent = approvedCount > 0 ? "Ready" : "None approved";

  // WhatsApp link
  const whatsappLink = $("#whatsappLink");
  if (whatsappLink) {
  const text = encodeURIComponent(`Ol√°! Aqui √© o portal do cliente ${state.client.name}. Preciso falar sobre conte√∫dos e aprova√ß√µes.`);
    whatsappLink.href = `https://wa.me/${state.client.whatsapp}?text=${text}`;
  }

  // Needs (only show open needs)
  const needs = $("#needs");
  if (needs) {
    needs.innerHTML = "";
    const openNeeds = (state.needs || []).filter(n => !n.status || n.status === 'open');
    if (openNeeds.length === 0) {
      needs.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:14px;">No open needs</div>';
    } else {
      openNeeds.forEach(n=>{
        const chipClass = n.severity==='bad'?'chip bad': (n.severity==='warn'?'chip warn':'chip');
        const row = el("div",{class:"row"},
          el("div",{class:"left"},
            el("div",{class:"status-dot", style:"background:"+(n.severity==='bad'?'#ef4444':'#f59e0b')}),
            el("div",{}, el("div",{html:n.text}), el("div",{class:"meta"}, "Missing from client"))
          ),
          el("span",{class:chipClass},"Pending")
        );
        needs.append(row);
      });
    }
  }

  // Requests
  const reqList = $("#requests"); 
  if (reqList) {
    reqList.innerHTML="";
    const openRequests = (state.requests || []).filter(r=>r.status!=='done').sort((a,b)=>b.createdAt-a.createdAt);
    if (openRequests.length === 0) {
      reqList.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:14px;">No open requests</div>';
    } else {
      openRequests.forEach(r=>{
    const left = el("div",{class:"left"},
          el("div",{class:"status-dot", style:"background:#2563eb"}),
          el("div",{style:"flex:1"},
            el("div",{class:"title-text", html:`${r.type}`}),
            el("div",{class:"meta", style:"margin-top:4px"}, r.details),
            el("div",{class:"meta", style:"margin-top:2px;font-size:12px"}, `${fmtDate(r.createdAt)} ‚Ä¢ ${r.by||'Client'}`)
          )
        );
        const row = el("div",{class:"row"}, left);
        reqList.append(row);
      });
    }
  }

  // Timeline
  const tl = $("#timeline"); 
  if (tl) {
    tl.innerHTML="";
    const activities = (state.activity || []).sort((a,b)=>b.when-a.when).slice(0,10);
    if (activities.length === 0) {
      tl.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:14px;">No recent activity</div>';
    } else {
      activities.forEach(a=>{
        const item = el("div",{class:"tl-item"});
        item.appendChild(el("div",{style:"font-size:14px;color:#0f172a;margin-bottom:4px;"}, a.text));
        item.appendChild(el("div",{class:"meta", style:"font-size:12px;color:#64748b;"}, fmtDate(a.when)));
        tl.append(item);
      });
    }
  }

  // Approvals (sectioned)
  try { renderApprovalsSectioned(); } catch(e){ console.warn("Approvals render skipped:", e); }
  
  // Calendar
  try { renderCalendar(); } catch(e){ console.warn("Calendar render skipped:", e); }
  
  // Request Stats
  try { renderRequestStats(); } catch(e){ console.warn("Request stats render skipped:", e); }
}

/* ================== Approvals Sectioned ================== */
function renderApprovalsSectioned(){
  const s = load(); 
  const items = s.approvals || [];
  
  // Filter items - pending includes items with no status or status === 'pending'
  const pending = items.filter(i => {
    const status = (i.status || '').toLowerCase().trim();
    return status === '' || status === 'pending';
  });
  const changes = items.filter(i => i.status === 'changes');
  const approved = items.filter(i => i.status === 'approved');

  // Note: Tab counts are now shown in the tab buttons themselves via badge indicators
  const $p=$("#approvalsPending"), $c=$("#approvalsChanges"), $a=$("#approvalsApproved"); 
  if(!$p||!$c||!$a) {
    console.error("Approval containers not found");
    return;
  }
  
  // Update tab badges if they exist
  const pendingTab = document.querySelector('[data-tab="pending"]');
  const changesTab = document.querySelector('[data-tab="changes"]');
  const approvedTab = document.querySelector('[data-tab="approved"]');
  if (pendingTab) pendingTab.textContent = `Pending${pending.length > 0 ? ` (${pending.length})` : ''}`;
  if (changesTab) changesTab.textContent = `Changes${changes.length > 0 ? ` (${changes.length})` : ''}`;
  if (approvedTab) approvedTab.textContent = `Approved${approved.length > 0 ? ` (${approved.length})` : ''}`;
  
  // Clear all lists
  $p.innerHTML="";
  $c.innerHTML="";
  $a.innerHTML="";
  if (changes.length === 0 && document.getElementById('laneChanges').style.display !== 'none') {
    $c.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:14px;">No changes requested</div>';
  }
  if (approved.length === 0 && document.getElementById('laneApproved').style.display !== 'none') {
    $a.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:14px;">No approved items</div>';
  }

  const getTypeIcon = (type) => {
    const typeLower = (type || '').toLowerCase();
    if (typeLower.includes('reel')) return 'üé•';
    if (typeLower.includes('story')) return '‚≠ï';
    if (typeLower.includes('post') || typeLower.includes('feed')) return 'üì∞';
    return 'üìÑ'; // default icon
  };

  const rowFor = (item) => {
    if (!item || !item.id) {
      console.warn("Invalid item:", item);
      return null;
    }
    
    // Title and type tag on same line
    const titleRow = el("div",{style:"display:flex;align-items:center;gap:8px;margin-bottom:6px;"});
    const titleDiv = el("div",{class:"title-text", style:"font-size:16px;font-weight:600;color:#1e40af;"});
    titleDiv.textContent = item.title || "Untitled";
    titleRow.appendChild(titleDiv);
    
    // Type tag next to title
    const typeTag = el("span",{class:"tag type-tag", style:"background:#dbeafe;color:#1e40af;font-size:12px;padding:4px 10px;border-radius:12px;font-weight:500;"});
    typeTag.textContent = item.type || "Post";
    titleRow.appendChild(typeTag);
    
    // Due date below title
    const dueDate = el("div",{style:"font-size:13px;color:#64748b;margin-top:2px;"});
    dueDate.textContent = `Due ${item.date || "N/A"}`;
    
    // Left content container
    const left = el("div",{style:"flex:1;min-width:0;display:flex;flex-direction:column;"});
    left.appendChild(titleRow);
    left.appendChild(dueDate);
    
    // Show change notes if present
    if (item.status==='changes' && item.change_notes?.length) {
      const noteDiv = el("div",{style:"font-size:12px;color:#64748b;margin-top:4px;"});
      noteDiv.textContent = `Note: "${item.change_notes.at(-1).note || ""}"`;
      left.appendChild(noteDiv);
    }

    // Right side - arrow icon only
    const right = el("div",{style:"display:flex;align-items:center;flex-shrink:0;margin-left:16px;"});
    
    // Arrow icon for navigation (always visible)
    const arrowIcon = el("div",{
      style:"width:24px;height:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#1e40af;flex-shrink:0;"
    });
    arrowIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
    arrowIcon.addEventListener('click', function(e) {
      e.stopPropagation();
      console.log("Arrow clicked, opening modal for:", item.id);
      const itemId = item.id;
      if (typeof window.openApprovalModal === 'function') {
        window.openApprovalModal(itemId);
      } else if (typeof openApprovalModal === 'function') {
        openApprovalModal(itemId);
      } else {
        console.error("openApprovalModal function not found!");
      }
    });
    right.appendChild(arrowIcon);

    // Row container
    const row = el("div",{
      class:"approval-item-row", 
      style:"display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px;border-radius:12px;background:#ffffff;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:pointer;transition:all 0.2s ease;"
    });
    
    // Add click handler
    row.addEventListener('click', function(e) {
      e.stopPropagation();
      console.log("Row clicked, opening modal for:", item.id);
      const itemId = item.id;
      if (typeof window.openApprovalModal === 'function') {
        window.openApprovalModal(itemId);
      } else if (typeof openApprovalModal === 'function') {
        openApprovalModal(itemId);
      } else {
        console.error("openApprovalModal function not found!");
        alert("Error: Cannot open approval modal. Please refresh the page.");
      }
    });
    
    row.addEventListener('mouseenter', function() {
      this.style.boxShadow = '0 4px 8px rgba(0,0,0,.15)';
      this.style.transform = 'translateY(-1px)';
    });
    row.addEventListener('mouseleave', function() {
      this.style.boxShadow = '0 1px 3px rgba(0,0,0,.1)';
      this.style.transform = 'translateY(0)';
    });
    row.appendChild(left);
    row.appendChild(right);
    
    return row;
  };

  // Render items
  let renderedPendingCount = 0;
  if (pending.length > 0) {
    pending.forEach(i=>{
      try {
        const row = rowFor(i);
        if (row) {
          $p.append(row);
          renderedPendingCount++;
        }
      } catch(e) {
        console.error("Error rendering pending item:", i, e);
      }
    });
  }
  
  // Show empty state only if no items were rendered
  if (renderedPendingCount === 0) {
    if (pending.length === 0) {
      $p.innerHTML = '<div style="text-align:center;padding:40px;color:#ffffff;font-size:14px;opacity:0.8;">No pending approvals</div>';
    } else {
      // Items exist but failed to render - show error
      $p.innerHTML = '<div style="text-align:center;padding:40px;color:#ff6b6b;font-size:14px;">Error rendering items. Please refresh the page.</div>';
    }
  }
  
  if (changes.length > 0) {
    changes.forEach(i=>{
      try {
        const row = rowFor(i);
        if (row) $c.append(row);
      } catch(e) {
        console.error("Error rendering changes item:", i, e);
      }
    });
  }
  
  if (approved.length > 0) {
    approved.forEach(i=>{
      try {
        const row = rowFor(i);
        if (row) $a.append(row);
      } catch(e) {
        console.error("Error rendering approved item:", i, e);
      }
    });
  }
  
  // Ensure pending lane is visible by default (when pending tab is active)
  const lanePending = document.getElementById('lanePending');
  if (lanePending && pendingTab && pendingTab.classList.contains('active')) {
    lanePending.style.display = 'block';
  }
  
}

// Tab switching for Approvals Queue
document.addEventListener("click", (e)=>{
  if(e.target && e.target.dataset.tab){
    const tab = e.target.dataset.tab;
    // Update active tab
    document.querySelectorAll('.approval-tab').forEach(btn => {
      btn.classList.remove('active');
    });
    e.target.classList.add('active');
    
    // Show/hide lanes
    $("#lanePending").style.display = tab === 'pending' ? 'block' : 'none';
    $("#laneChanges").style.display = tab === 'changes' ? 'block' : 'none';
    $("#laneApproved").style.display = tab === 'approved' ? 'block' : 'none';
  }
});

/* ================== Approval Actions ================== */
function approveItem(id){
  console.log("approveItem called with id:", id);
  const s = load(); 
  const item = s.approvals.find(a=>a.id===id); 
  if(!item) {
    console.error("Item not found for approval:", id);
    return;
  }
  
  item.status = "approved";
  if(s.kpis && typeof s.kpis.waitingApproval === 'number'){ 
    s.kpis.waitingApproval = Math.max(0, s.kpis.waitingApproval - 1); 
  }
  save(s);
  notifyTeam({ type:"approval", itemId:id, title:item.title, status:"approved", activityText:`Approved: ${item.title}` });
  
  // Close modal
  closeApprovalModal();
  
  // Re-render to update the list
  render();
  console.log("Item approved and list updated");
}

function deleteApprovalItem(id){
  console.log("deleteApprovalItem called with id:", id);
  if (!confirm("Are you sure you want to delete this approval item?")) {
    console.log("Delete cancelled by user");
    return;
  }
  
  const s = load();
  const item = s.approvals.find(a=>a.id===id);
  if (!item) {
    console.error("Item not found for deletion:", id);
    return;
  }
  
  console.log("Deleting item:", item.title);
  s.approvals = s.approvals.filter(a => a.id !== id);
  
  // Update pending count
  const pendingCount = s.approvals.filter(a => !a.status || a.status === 'pending').length;
  if(s.kpis && typeof s.kpis.waitingApproval === 'number'){ 
    s.kpis.waitingApproval = pendingCount; 
  }
  
  save(s);
  notifyTeam({ type:"delete", itemId:id, title:item.title, activityText:`Deleted: ${item.title}` });
  
  // Close modal
  closeApprovalModal();
  
  // Re-render to update the list
  render();
  console.log("Item deleted and list updated");
}

let CURRENT_APPROVAL_ITEM = null;

// Make function globally accessible
window.openApprovalModal = function(id){
  console.log("openApprovalModal called with id:", id);
  const s = load(); 
  const item = s.approvals.find(a=>a.id===id); 
  if(!item) {
    console.warn("Item not found:", id);
    return;
  }
  
  console.log("Found item:", item);
  CURRENT_APPROVAL_ITEM = id;
  
  // Set title
  const approvalTitle = $("#approvalTitle");
  if (approvalTitle) approvalTitle.textContent = item.title;
  
  // Set image
  const approvalImage = $("#approvalImage");
  if (approvalImage && item.imageUrl) {
    approvalImage.src = item.imageUrl;
    approvalImage.alt = item.title;
    approvalImage.onerror = function() {
      this.src = `https://via.placeholder.com/600x400/2563eb/ffffff?text=${encodeURIComponent(item.title)}`;
    };
  }
  
  // Set Instagram link
  const instagramLink = $("#approvalInstagramLink");
  if (instagramLink) {
    if (item.instagramLink) {
      instagramLink.href = item.instagramLink;
      instagramLink.style.display = "inline-flex";
    } else {
      instagramLink.href = "#";
      instagramLink.style.display = "none";
    }
  }
  
  // Set caption
  const approvalCaption = $("#approvalCaption");
  if (approvalCaption) {
    approvalCaption.textContent = item.caption || "No caption provided.";
  }
  
  // Show/hide change request notes section
  const changeRequestContainer = $("#changeRequestContainer");
  const changeRequestNotes = $("#changeRequestNotes");
  if (changeRequestContainer && changeRequestNotes) {
    if (item.status === "changes" && item.change_notes && item.change_notes.length > 0) {
      // Show the most recent change request note
      const latestNote = item.change_notes[item.change_notes.length - 1];
      changeRequestNotes.textContent = latestNote.note || "Change requested.";
      changeRequestContainer.style.display = "block";
    } else {
      changeRequestContainer.style.display = "none";
    }
  }
  
  // Hide changes form
  const changesForm = $("#changesFormContainer");
  if (changesForm) changesForm.style.display = "none";
  const cancelBtn = $("#cancelChangesBtn");
  if (cancelBtn) cancelBtn.style.display = "none";
  
  // Show/hide buttons based on status
  const approveBtn = $("#approveBtn");
  const requestChangesBtn = $("#requestChangesBtn");
  if (item.status === "approved") {
    if (approveBtn) approveBtn.style.display = "none";
    if (requestChangesBtn) requestChangesBtn.style.display = "none";
  } else {
    if (approveBtn) approveBtn.style.display = "block";
    if (requestChangesBtn) requestChangesBtn.style.display = "block";
  }
  
  // Show modal
  const approvalModal = document.getElementById("approvalModal");
  console.log("Modal element:", approvalModal);
  if (approvalModal) {
    approvalModal.classList.add("show");
    console.log("Modal should be visible now, classList:", approvalModal.classList.toString());
    // Force display
    approvalModal.style.display = "flex";
  } else {
    console.error("Modal element not found! Looking for #approvalModal");
  }
};

// Also create a regular function for backwards compatibility
function openApprovalModal(id) {
  window.openApprovalModal(id);
}

// Close modal function
function closeApprovalModal() {
  console.log("closeApprovalModal called");
  const modal = document.getElementById("approvalModal");
  if (modal) {
    modal.classList.remove("show");
    modal.style.display = "none";
    CURRENT_APPROVAL_ITEM = null;
    // Reset form
    const changesForm = document.getElementById("changesFormContainer");
    if (changesForm) changesForm.style.display = "none";
    const cancelBtn = document.getElementById("cancelChangesBtn");
    if (cancelBtn) cancelBtn.style.display = "none";
    const changesText = document.getElementById("changesText");
    if (changesText) changesText.value = "";
    console.log("Modal closed");
  } else {
    console.error("Modal element not found for closing");
  }
}

// Close on ESC key
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    const modal = document.getElementById("approvalModal");
    if (modal && modal.classList.contains("show")) {
      closeApprovalModal();
    }
  }
});

// Use event delegation on the modal panel for all button clicks
function setupModalEventDelegation() {
  const modalPanel = document.querySelector('.approval-modal-panel');
  if (!modalPanel) {
    console.warn("Modal panel not found, will retry on DOMContentLoaded");
    return;
  }
  
  // Remove any existing listener to avoid duplicates
  modalPanel.removeEventListener('click', modalPanel._clickHandler);
  
  modalPanel._clickHandler = function(e) {
    const target = e.target;
    const btn = target.closest('button');
    
    if (!btn) return;
    
    // Approve Button
    if (btn.id === 'approveBtn') {
      e.preventDefault();
      e.stopPropagation();
      console.log("Approve button clicked");
      if (CURRENT_APPROVAL_ITEM) {
        approveItem(CURRENT_APPROVAL_ITEM);
      }
      return;
    }
    
    // Delete Button
    if (btn.id === 'deleteApprovalBtn') {
      e.preventDefault();
      e.stopPropagation();
      console.log("Delete button clicked");
      if (CURRENT_APPROVAL_ITEM) {
        deleteApprovalItem(CURRENT_APPROVAL_ITEM);
      }
      return;
    }
    
    // Request Changes Button
    if (btn.id === 'requestChangesBtn') {
      e.preventDefault();
      e.stopPropagation();
      console.log("Request Changes button clicked");
      const changesForm = document.getElementById("changesFormContainer");
      const cancelBtn = document.getElementById("cancelChangesBtn");
      if (changesForm) changesForm.style.display = "block";
      if (cancelBtn) cancelBtn.style.display = "block";
      const changesText = document.getElementById("changesText");
      if (changesText) {
        changesText.value = "";
        setTimeout(() => changesText.focus(), 100);
      }
      return;
    }
    
    // Cancel Changes Button
    if (btn.id === 'cancelChangesBtn') {
      e.preventDefault();
      e.stopPropagation();
      console.log("Cancel button clicked");
      const changesForm = document.getElementById("changesFormContainer");
      const cancelBtn = document.getElementById("cancelChangesBtn");
      if (changesForm) changesForm.style.display = "none";
      if (cancelBtn) cancelBtn.style.display = "none";
      const changesText = document.getElementById("changesText");
      if (changesText) changesText.value = "";
      return;
    }
    
    // Submit Changes Button
    if (btn.id === 'submitChangesBtn' || btn.classList.contains('submit-changes-btn')) {
      e.preventDefault();
      e.stopPropagation();
      console.log("Submit Changes button clicked");
      const changesText = document.getElementById("changesText");
      const note = changesText ? changesText.value.trim() : "";
      
      if(!CURRENT_APPROVAL_ITEM) {
        console.error("No current approval item");
        return;
      }
      if(!note) {
        alert("Please describe what needs to be changed.");
        return;
      }
      
      const s = load(); 
      const item = s.approvals.find(a=>a.id===CURRENT_APPROVAL_ITEM); 
      if(!item) {
        console.error("Item not found:", CURRENT_APPROVAL_ITEM);
        return;
      }
      
      item.status = "changes"; 
      item.change_notes = item.change_notes || []; 
      item.change_notes.push({ when: Date.now(), note });
      
      save(s); 
  notifyTeam({ type:"needs_changes", itemId:item.id, title:item.title, note, activityText:`Changes requested: ${item.title}` });
      
      closeApprovalModal();
  render();
      return;
    }
    
    // Close button (X) - check for ID or data attribute
    if (btn.id === 'closeModalBtn' || btn.hasAttribute('data-close-modal')) {
      e.preventDefault();
      e.stopPropagation();
      console.log("Close button clicked via delegation");
      closeApprovalModal();
      return;
    }
  };
  
  modalPanel.addEventListener('click', modalPanel._clickHandler);
  
  // Also add direct handlers as fallback
  const closeBtn = document.getElementById('closeModalBtn');
  if (closeBtn) {
    closeBtn.onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log("Close button clicked directly");
      closeApprovalModal();
    };
  }
  
  const deleteBtn = document.getElementById('deleteApprovalBtn');
  if (deleteBtn) {
    deleteBtn.onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log("Delete button clicked directly");
      if (CURRENT_APPROVAL_ITEM) {
        deleteApprovalItem(CURRENT_APPROVAL_ITEM);
      }
    };
  }
}

// Setup when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupModalEventDelegation);
} else {
  setupModalEventDelegation();
}

// Also handle clicks on the modal backdrop
document.addEventListener('click', function(e) {
  const modal = document.getElementById("approvalModal");
  if (modal && modal.classList.contains("show")) {
    // Check if click is on backdrop or modal itself (but not on panel)
    if (e.target === modal || e.target.classList.contains('modal__backdrop')) {
      e.preventDefault();
      e.stopPropagation();
      closeApprovalModal();
    }
  }
});

/* ================== Requests ================== */
const requestForm = $("#requestForm");
if (requestForm) {
  requestForm.addEventListener("submit", e=>{
  e.preventDefault();
  const reqType = $("#reqType").value;
  if (!reqType) {
    alert("Please select a request type");
    return;
  }
  
  const s = load();
  const req = {
    id:"r"+Math.random().toString(36).slice(2,7),
    type: reqType,
    by: $("#reqContact").value.trim() || "Client",
    details: $("#reqDetails").value.trim() || "(no details)",
    link: $("#reqLink").value.trim(),
    status: "open", 
    createdAt: Date.now() // Always set createdAt when creating a request
  };
  
  // Add request to list
  if (!s.requests) s.requests = [];
  s.requests.push(req);
  
  // Add to activity timeline
  if (!s.activity) s.activity = [];
  const activityText = `New request submitted: ${req.type}${req.details !== "(no details)" ? " - " + req.details.substring(0, 50) + (req.details.length > 50 ? "..." : "") : ""}`;
  s.activity.unshift({when:Date.now(), text:activityText});
  
  save(s);
  e.target.reset();
  
  // Show success message
  const submitBtn = e.target.querySelector('button[type="submit"]');
  if (submitBtn) {
    const originalText = submitBtn.textContent;
    const originalStyle = submitBtn.style.cssText;
    submitBtn.textContent = "‚úì Submitted!";
    submitBtn.style.background = "#22c55e";
    submitBtn.style.color = "#ffffff";
    setTimeout(() => {
      submitBtn.textContent = originalText;
      submitBtn.style.cssText = originalStyle;
      submitBtn.style.background = "#ffffff";
      submitBtn.style.color = "#0f172a";
    }, 2000);
  }
  
  // Re-render everything
  render();
  
  // Recalculate request metrics (includes both requests and needs)
  renderRequestStats();
  
  // Scroll to Open Requests section
  setTimeout(() => {
    const requestsEl = document.querySelector('#requests');
    if (requestsEl) requestsEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 100);
  });
}
function closeRequest(id){ 
  const s=load(); 
  const r=s.requests.find(x=>x.id===id); 
  if(r){ 
    r.status='done'; 
    r.doneAt = Date.now(); // Use doneAt instead of completedAt
    // Ensure createdAt exists (for backward compatibility)
    if (!r.createdAt) r.createdAt = Date.now();
    // Add to activity timeline at the beginning
    if (!s.activity) s.activity = [];
    s.activity.unshift({when:Date.now(), text:`Request completed: ${r.type}${r.details !== "(no details)" ? " - " + r.details.substring(0, 40) + (r.details.length > 40 ? "..." : "") : ""}`}); 
    save(s); 
    render();
    // Recalculate request metrics after marking done
    renderRequestStats();
  }
}

// Function to mark need as done (for client view if needed)
function markNeedDone(id) {
  const s = load();
  const need = (s.needs || []).find(n => n.id === id);
  if (!need) return;
  
  // Mark as done instead of deleting
  need.status = 'done';
  need.doneAt = Date.now();
  
  // Update missing assets count (only count open needs)
  const openNeeds = (s.needs || []).filter(n => !n.status || n.status === 'open');
  if (s.kpis) {
    s.kpis.missingAssets = openNeeds.length;
  }
  
  // Log activity
  if (!s.activity) s.activity = [];
  s.activity.unshift({
    when: Date.now(),
    text: `Completed need: ${need.text.substring(0, 40)}${need.text.length > 40 ? '...' : ''}`
  });
  
  save(s);
  render();
  // Recalculate needs metrics
  renderRequestStats();
}

/* ================== Calendar ================== */
function renderCalendar(){
  const s = load();
  const container = $("#calendarView");
  if (!container) return;
  
  container.innerHTML = "";
  
  // Get all approvals with postDate (pending or approved)
  const itemsWithDate = (s.approvals || []).filter(a => 
    a.postDate && 
    (a.status === 'pending' || a.status === 'approved' || !a.status)
  );
  
  if (itemsWithDate.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:14px;">No posts scheduled. Posts with a Post Date will appear here.</div>';
    return;
  }
  
  // Group by month
  const groupedByMonth = {};
  const monthKeys = [];
  itemsWithDate.forEach(item => {
    const date = new Date(item.postDate);
    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    const monthLabel = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
    if (!groupedByMonth[monthKey]) {
      groupedByMonth[monthKey] = {
        label: monthLabel,
        items: []
      };
      monthKeys.push(monthKey);
    }
    groupedByMonth[monthKey].items.push(item);
  });
  
  // Sort months (ascending) by key
  monthKeys.sort((a, b) => a.localeCompare(b));
  
  monthKeys.forEach(monthKey => {
    const monthData = groupedByMonth[monthKey];
    const monthGroup = el("div", { class: "calendar-month-group" });
    
    // Get month index (0-11) for color coding
    const firstPostDate = new Date(monthData.items[0].postDate);
    const monthIndex = firstPostDate.getMonth();
    
    // Month header with colored background
    const monthHeader = el("div", { 
      class: `calendar-month-header month-${monthIndex}`
    });
    monthHeader.textContent = monthData.label.toUpperCase();
    monthGroup.appendChild(monthHeader);
    
    // Posts for this month - sort by date
    const posts = monthData.items.sort((a, b) => {
      return new Date(a.postDate) - new Date(b.postDate);
    });
    
    posts.forEach(item => {
      const date = new Date(item.postDate);
      const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      
      // Use the same row format as approval items
      const titleRow = el("div", { style: "display:flex;align-items:center;gap:8px;margin-bottom:6px;" });
      const titleDiv = el("div", { class: "title-text", style: "font-size:16px;font-weight:600;color:#1e40af;" });
      titleDiv.textContent = item.title || "Untitled";
      titleRow.appendChild(titleDiv);
      
      // Type tag (Post/Reel/Story)
      const typeTag = el("span", { class: "tag type-tag", style: "background:#dbeafe;color:#1e40af;font-size:12px;padding:4px 10px;border-radius:12px;font-weight:500;" });
      typeTag.textContent = item.type || "Post";
      titleRow.appendChild(typeTag);
      
      // Status chip - always "Scheduled"
      const statusChip = el("span", {
        style: `font-size:12px;padding:4px 10px;border-radius:12px;font-weight:500;background:#e0f2fe;color:#0369a1;`
      });
      statusChip.textContent = 'Scheduled';
      titleRow.appendChild(statusChip);
      
      // Date below title
      const postDate = el("div", { style: "font-size:13px;color:#64748b;margin-top:2px;" });
      postDate.textContent = formattedDate;
      
      // Left content container
      const left = el("div", { style: "flex:1;min-width:0;display:flex;flex-direction:column;" });
      left.appendChild(titleRow);
      left.appendChild(postDate);
      
      // Right side - arrow icon (optional, for consistency)
      const right = el("div", { style: "display:flex;align-items:center;flex-shrink:0;margin-left:16px;" });
      const arrowIcon = el("div", {
        style: "width:24px;height:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#1e40af;flex-shrink:0;"
      });
      arrowIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
      arrowIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        if (typeof window.openApprovalModal === 'function') {
          window.openApprovalModal(item.id);
        }
      });
      right.appendChild(arrowIcon);
      
      // Row container (same style as approval rows)
      const row = el("div", {
        class: "approval-item-row", 
        style: "display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px;border-radius:12px;background:#ffffff;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:pointer;transition:all 0.2s ease;margin-bottom:12px;"
      });
      
      // Add click handler to open modal
      row.addEventListener('click', function(e) {
        e.stopPropagation();
        if (typeof window.openApprovalModal === 'function') {
          window.openApprovalModal(item.id);
        }
      });
      
      row.addEventListener('mouseenter', function() {
        this.style.boxShadow = '0 4px 8px rgba(0,0,0,.15)';
        this.style.transform = 'translateY(-1px)';
      });
      row.addEventListener('mouseleave', function() {
        this.style.boxShadow = '0 1px 3px rgba(0,0,0,.1)';
        this.style.transform = 'translateY(0)';
      });
      
      row.appendChild(left);
      row.appendChild(right);
      
      monthGroup.appendChild(row);
    });
    
    container.appendChild(monthGroup);
  });
}

/* ================== Request Stats ================== */
function renderRequestStats(){
  const s = load();
  const circumference = 2 * Math.PI * 50; // radius = 50
  
  // Calculate Request From clients / Completed %
  const allRequests = s.requests || [];
  const completedRequests = allRequests.filter(r => r.status === 'done');
  const totalRequests = allRequests.length;
  const completedPercent = totalRequests > 0 ? Math.round((completedRequests.length / totalRequests) * 100) : 0;
  
  // Update Request From clients percentage ring and text
  const completedOffset = circumference - (completedPercent / 100) * circumference;
  const completedRing = $("#completedRing");
  const completedPercentEl = $("#completedPercent");
  if (completedRing) {
    completedRing.style.strokeDasharray = circumference;
    completedRing.style.strokeDashoffset = completedOffset;
  }
  if (completedPercentEl) {
    completedPercentEl.textContent = completedPercent + "%";
  }
  
  // Calculate What we need from you / Completed %
  const allNeeds = s.needs || [];
  const completedNeeds = allNeeds.filter(n => n.status === 'done');
  const totalNeeds = allNeeds.length;
  const needsPercent = totalNeeds > 0 ? Math.round((completedNeeds.length / totalNeeds) * 100) : 0;
  
  // Update What we need from you percentage ring and text
  const needsOffset = circumference - (needsPercent / 100) * circumference;
  const needsRing = $("#needsRing");
  const needsPercentEl = $("#needsPercent");
  if (needsRing) {
    needsRing.style.strokeDasharray = circumference;
    needsRing.style.strokeDashoffset = needsOffset;
  }
  if (needsPercentEl) {
    needsPercentEl.textContent = needsPercent + "%";
  }
}

/* ================== Reports (manual, positive-only) ================== */
const LS_REPORTS_KEY = "client_portal_reports_v1";
const TEAM_PIN = "2468";
const reportSeed = {
  period: "Nov 2025",
  ads:{ running:4, impressions:48000, clicks:1200, leads:35 },
  visibility:{ gmbViews:3800, profileSearches:1200, websiteClicks:220, igFollowersDelta:75 },
  work:{ posts:16, reels:8, campaigns:2, requestsResolved:3 },
  prev:{ period:"Oct 2025", ads:{ running:3, impressions:42000, clicks:1100, leads:31 }, visibility:{ gmbViews:3220, profileSearches:1090, websiteClicks:208, igFollowersDelta:54 }, work:{ posts:15, reels:6, campaigns:1, requestsResolved:2 } }
};
function loadReports(){ const raw = localStorage.getItem(LS_REPORTS_KEY); if(!raw){ localStorage.setItem(LS_REPORTS_KEY, JSON.stringify(reportSeed)); return reportSeed; } try{ return JSON.parse(raw);}catch{return reportSeed;} }
function saveReports(r){ localStorage.setItem(LS_REPORTS_KEY, JSON.stringify(r)); }
function pctChange(cur, prev){ if(prev===0) return 100; return Math.round(((cur - prev) / prev) * 100); }
function positivePhrase(label, p){ if(p>0) return `${label} up ${p}% vs last period`; if(p===0) return `${label} holding steady`; return `${label} steady with ongoing optimization`; }
function summarizePositive(r, prev){
  const parts=[]; if(prev){ const imp=pctChange(r.ads.impressions,prev.ads.impressions); const leads=pctChange(r.ads.leads,prev.ads.leads); const views=pctChange(r.visibility.gmbViews,prev.visibility.gmbViews);
    parts.push(leads>0?`More leads this period (+${leads}%).`:`Lead flow steady while we scale creatives.`);
    parts.push(imp>0?`Reach expanded (+${imp}%).`:`Reach consistent with stable delivery.`);
    parts.push(views>0?`Google visibility growing (+${views}%).`:`Google visibility holding while we test new posts.`);
  } else { parts.push(`Ads delivering consistent reach and visibility.`); }
  parts.push(`Content engine on track: ${r.work.posts} posts, ${r.work.reels} reels.`); return parts.join(" ");
}
function renderReports(){
  const r = loadReports(); const prev = r.prev;
  const adsRunning = r.ads.running;
  const impText = prev ? positivePhrase("Impressions", pctChange(r.ads.impressions, prev.ads.impressions)) : "Impressions trending positively";
  const growthScore = prev ? Math.max(0, pctChange(r.visibility.gmbViews + r.visibility.profileSearches + r.visibility.websiteClicks, prev.visibility.gmbViews + prev.visibility.profileSearches + prev.visibility.websiteClicks)) : 0;

  const rAdsRunning = $("#r-ads-running");
  if (rAdsRunning) rAdsRunning.textContent = `${adsRunning} Running`;
  
  const rAdsSub = $("#r-ads-sub");
  if (rAdsSub) rAdsSub.textContent = `${r.ads.impressions.toLocaleString()} impressions ‚Ä¢ ${impText}`;
  
  const rAdsChip = $("#r-ads-chip");
  if (rAdsChip) rAdsChip.textContent = (prev && pctChange(r.ads.leads, prev.ads.leads) > 0) ? "More leads this period" : "Performing well";

  const rGrowthScore = $("#r-growth-score");
  if (rGrowthScore) rGrowthScore.textContent = prev ? `+${growthScore}%` : "Growing";
  
  const rGrowthSub = $("#r-growth-sub");
  if (rGrowthSub) rGrowthSub.textContent = `${r.visibility.gmbViews.toLocaleString()} Google views ‚Ä¢ ${r.visibility.profileSearches.toLocaleString()} profile searches`;
  
  const rGrowthChip = $("#r-growth-chip");
  if (rGrowthChip) rGrowthChip.textContent = (growthScore > 0) ? "Visibility up" : "Visibility steady";

  const workList = $("#r-work-list");
  if (workList) {
    workList.innerHTML="";
  const w=r.work, labelMap={posts:"posts published", reels:"reels edited", campaigns:"campaigns launched", requestsResolved:"client requests resolved"};
    ["posts","reels","campaigns","requestsResolved"].forEach(k=>{ 
      const li=document.createElement("li"); 
      li.textContent=`${w[k]} ${labelMap[k]}`; 
      workList.appendChild(li); 
    });
  }
  
  const rWorkSub = $("#r-work-sub");
  if (rWorkSub) rWorkSub.textContent = `Period: ${r.period}`;
  
  const rSummary = $("#r-summary");
  if (rSummary) rSummary.textContent = summarizePositive(r, prev);
}
// Admin form
(function setupReportsAdmin(){
  const openBtn=$("#openReportsAdmin"), admin=$("#reportsAdmin"), form=$("#reportsForm"), cancel=$("#cancelReports");
  if (openBtn) {
    openBtn.addEventListener("click", ()=>{ admin.style.display = admin.style.display==="none"?"block":"none"; });
  }
  cancel.addEventListener("click", ()=> admin.style.display="none");
  form.addEventListener("submit", (e)=>{
    e.preventDefault(); const pin=$("#repPin").value.trim(); if(pin!==TEAM_PIN){ alert("Invalid PIN"); return; }
    const cur=loadReports(); const prev=JSON.parse(JSON.stringify(cur));
    const val=(id,f=0)=>{ const v=document.getElementById(id).value.replace(/[, ]/g,""); return v?parseInt(v):f; };
    const next={
      period: $("#repPeriod").value.trim()||cur.period,
      ads:{ running:val("repAdsRunning",cur.ads.running), impressions:val("repImpressions",cur.ads.impressions), clicks:val("repClicks",cur.ads.clicks), leads:val("repLeads",cur.ads.leads) },
      visibility:{ gmbViews:val("repGmbViews",cur.visibility.gmbViews), profileSearches:val("repProfileSearches",cur.visibility.profileSearches), websiteClicks:val("repWebsiteClicks",cur.visibility.websiteClicks), igFollowersDelta:val("repIgFollowers",cur.visibility.igFollowersDelta) },
      work:{ posts:val("repPosts",cur.work.posts), reels:val("repReels",cur.work.reels), campaigns:val("repCampaigns",cur.work.campaigns), requestsResolved:val("repRequests",cur.work.requestsResolved) },
      prev
    };
    localStorage.setItem(LS_REPORTS_KEY, JSON.stringify(next)); admin.style.display="none"; renderReports();
    const s=load(); s.activity.push({ when:Date.now(), text:`Report updated: ${next.period}` }); save(s); render();
  });
})();

/* ================== Misc events ================== */
const markAllReadBtn = $("#markAllRead");
if (markAllReadBtn) {
  markAllReadBtn.addEventListener("click", ()=>{ 
    const s=load(); 
    s.seen=true; 
    s.activity.push({when:Date.now(), text:`Portal checked by client`}); 
    save(s); 
    render(); 
  });
}

const toggleModeBtn = $("#toggleMode");
if (toggleModeBtn) {
  toggleModeBtn.addEventListener("click", ()=>{
  const isDark = document.body.dataset.theme==='dark'; 
  document.body.dataset.theme = isDark ? 'light' : 'dark';
});
}

/* ================== Boot ================== */
// Initialize on page load
function initializeApp() {
  // Ensure pending tab is active and visible on initial load
  const pendingTab = document.querySelector('[data-tab="pending"]');
  const lanePending = document.getElementById('lanePending');
  if (pendingTab && lanePending) {
    pendingTab.classList.add('active');
    lanePending.style.display = 'block';
  }
  
  // Update client name immediately from session before rendering (fixes "Loading..." issue)
  const clientNameEl = document.getElementById("clientName");
  if (clientNameEl) {
    let displayName = "Client";
    try {
      // Try to get fresh session
      const freshSession = checkAuth();
      if (freshSession && freshSession.clientName) {
        displayName = freshSession.clientName;
      } else if (typeof session !== 'undefined' && session && session.clientName) {
        displayName = session.clientName;
      } else {
        // Fallback to state if session doesn't have name
        const state = load();
        if (state && state.client && state.client.name) {
          displayName = state.client.name;
        }
      }
    } catch(e) {
      console.warn("Error getting session for client name:", e);
      // Try state as fallback
      try {
        const state = load();
        if (state && state.client && state.client.name) {
          displayName = state.client.name;
        }
      } catch(e2) {
        console.error("Could not load state:", e2);
      }
    }
    clientNameEl.textContent = displayName;
    console.log("Initial client name set to:", displayName);
  }
  
  // Load logo after name is set
  loadClientLogo();
  
  // Set up logout button as backup (onclick should already work, but this ensures it's attached)
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener("click", window.handleLogout);
    console.log("Logout button event listener attached");
  }
  
  // Render everything (this will also update the name again if needed)
  render(); 
  renderReports();
  
  // Re-render approvals to ensure they show (sometimes DOM isn't ready)
  setTimeout(() => {
    try {
      renderApprovalsSectioned();
      const lanePending2 = document.getElementById('lanePending');
      if (lanePending2) {
        lanePending2.style.display = 'block';
      }
    } catch(e) {
      console.error("Error in delayed render:", e);
    }
  }, 100);
}

// Run when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  // DOM is already ready
  initializeApp();
}
</script>
</body>
</html>
